# Исправление ошибки SMTP "socket disconnected"

## Проблема
Ошибка: "Client network socket disconnected before secure TLS connection was established"
Или другие ошибки подключения к Mail.ru.

## 1. Самое важное: Пароль для внешних приложений

Mail.ru часто блокирует вход по обычному паролю от почты, особенно для сторонних приложений.
**Вам нужно создать специальный пароль для сайта:**

1. Зайдите в почту Mail.ru через браузер.
2. Нажмите на иконку профиля -> **Пароль и безопасность**.
3. Выберите **Пароли для внешних приложений**.
4. Нажмите **Добавить**.
5. Введите название (например, "Сайт ZenitMed").
6. Скопируйте полученный пароль.
7. Вставьте этот пароль в файл `.env.local` в поле `SMTP_PASSWORD`:
   ```env
   SMTP_PASSWORD=ваш_новый_пароль_приложения
   ```
8. Перезапустите сервер (`npm run dev`).

## 2. Использование порта 587 (STARTTLS)

Если порт 465 не работает, попробуйте порт 587. Это часто помогает с проблемами TLS.

1. В файле `.env.local`:
   ```env
   SMTP_PORT=587
   ```
2. Перезапустите сервер.

## 3. Диагностика

Я обновил скрипт проверки SMTP. Теперь он показывает гораздо больше информации.

1. Откройте в браузере: `http://localhost:3000/api/test-smtp`
2. Посмотрите на результат.
   - Если видите "Ошибка подключения (verify)" - проблема в сети или настройках хоста/порта.
   - Если "Ошибка аутентификации" - проблема в логине/пароле (нужен пароль приложения).
   - Если "Timeout" - проблема в файрволе или антивирусе.

## 4. Проверка переменных

Запустите скрипт проверки переменных, чтобы убедиться, что Node.js их видит:
```powershell
.\check-env.ps1
```

## 5. Файрвол

Если ничего не помогает, временно отключите антивирус/файрвол, чтобы проверить, не блокируют ли они исходящие соединения на порты 465/587.

## 6. IPv6

Иногда проблема связана с IPv6. Я принудительно включил использование IPv4 в конфигурации. Попробуйте перезапустить сервер и проверить снова.
