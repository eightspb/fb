# Миграция изображений в базу данных

Этот документ описывает процесс миграции всех изображений новостей из файловой системы в базу данных PostgreSQL.

## Зачем это нужно?

- **Единое хранилище**: Все данные (текст и изображения) находятся в одной базе данных
- **Упрощение деплоя**: Не нужно синхронизировать файлы между серверами
- **Производительность**: Изображения отдаются через оптимизированный API endpoint
- **Безопасность**: Контроль доступа через RLS политики базы данных

## Требования

1. База данных PostgreSQL должна быть запущена и доступна
2. Таблица `news_images` должна содержать колонки `image_data` (BYTEA) и `mime_type` (TEXT)
3. Переменная окружения `DATABASE_URL` должна быть установлена

## Выполнение миграции

### Локально (без Docker)

```bash
npm run migrate:all-images-to-db
```

### В Docker контейнере

```bash
npm run docker:migrate-all-images
```

## Что делает скрипт?

1. **Находит все изображения** в таблице `news_images`, где `image_data IS NULL`
2. **Умный поиск файлов** с обработкой:
   - Кириллицы и специальных символов (URL-декодирование)
   - Пробелов (обычные, `%20`, `+`)
   - Разных форматов путей (Windows/Unix)
   - Преобразования дат (DD.MM.YYYY → YYYY.MM.DD)
   - Рекурсивного поиска по имени файла, если путь неправильный
3. **Читает файлы** из файловой системы (`/public/images/...`)
4. **Загружает в БД** бинарные данные в колонку `image_data`
5. **Определяет MIME-тип** и сохраняет в `mime_type`
6. **Пропускает**:
   - Внешние URL (http/https)
   - Файлы больше 50MB
   - Видеофайлы (.mov, .mp4 и т.д.)
   - Уже загруженные изображения

## Обработка специальных символов

Скрипт корректно обрабатывает:
- ✅ **Кириллицу** в именах файлов (например: "Школа радиотерапевта.JPG")
- ✅ **Пробелы** в именах (например: "2018-11-3-4  1 ШИМ 4 РАН СПб.JPG")
- ✅ **URL-кодирование** (автоматическое декодирование `%D0%A8` → `Ш`)
- ✅ **Разные форматы путей** (Windows `\` и Unix `/`)
- ✅ **Неправильные пути в БД** (рекурсивный поиск по имени файла)

## Результат

После успешной миграции:
- Все изображения доступны через `/api/images/{id}`
- API новостей возвращает только изображения из БД
- Файлы в `/public/images/` больше не используются для новостей

## Проверка результатов

После миграции проверьте:

```sql
-- Сколько изображений загружено в БД
SELECT COUNT(*) FROM news_images WHERE image_data IS NOT NULL;

-- Сколько изображений осталось без данных
SELECT COUNT(*) FROM news_images WHERE image_data IS NULL AND image_url NOT LIKE 'http%' AND image_url != 'stored_in_db';

-- Размер данных изображений
SELECT 
  pg_size_pretty(SUM(LENGTH(image_data))) as total_size
FROM news_images 
WHERE image_data IS NOT NULL;
```

## Обработка ошибок

Если некоторые изображения не были загружены:
1. Проверьте логи миграции на наличие ошибок
2. Убедитесь, что файлы существуют в указанных путях
3. Проверьте права доступа к файлам
4. Для больших файлов (>50MB) рассмотрите использование внешнего хранилища

## Откат миграции

Если нужно вернуться к файловой системе:
1. Обновите код API, чтобы использовать файловые пути
2. Данные в БД можно оставить (они не мешают)

## Примечания

- Скрипт безопасен для повторного запуска - он пропускает уже загруженные изображения
- Внешние URL (http/https) не загружаются в БД, они остаются как есть
- Рекомендуется сделать резервную копию базы данных перед миграцией
