# Хранение изображений в базе данных

## Обзор

Все изображения в приложении хранятся **только в базе данных**, а не в файловой системе. Это обеспечивает:

✅ Единый источник данных  
✅ Нет зависимости от файловой системы  
✅ Простой деплой без загрузки файлов  
✅ Централизованное управление изображениями  

## Архитектура

### Хранение

Изображения хранятся в таблице `news_images`:
- `id` - UUID изображения
- `image_data` - бинарные данные изображения (BYTEA)
- `mime_type` - MIME-тип изображения (например, `image/jpeg`)
- `image_url` - оригинальный путь (для справки, не используется для отображения)

### Отображение

Изображения отображаются через API endpoint:
```
GET /api/images/{id}
```

Этот endpoint:
1. Читает `image_data` и `mime_type` из БД
2. Возвращает бинарные данные с правильными HTTP заголовками
3. Устанавливает кэширование для производительности

### Использование в коде

Все компоненты используют только изображения из БД:

```typescript
// ✅ Правильно - изображения из БД
images: images
  .filter((img: any) => img.has_data) // Только изображения из БД
  .map((img: any) => `/api/images/${img.id}`)

// ❌ Неправильно - чтение из файловой системы
images: images.map((img: any) => img.image_url) // НЕ ИСПОЛЬЗУЕТСЯ
```

## Миграция изображений

Если у вас есть изображения в файловой системе (`public/images/trainings/`), их нужно импортировать в БД:

```bash
# Локально
npm run migrate:db-images

# Через Docker
docker exec -i fb-net-nextjs-prod npx tsx scripts/import-images-to-db.ts
```

Скрипт:
1. Находит все записи в `news_images` без данных (`image_data IS NULL`)
2. Читает файлы по путям из `image_url`
3. Сохраняет данные в `image_data` и `mime_type`

## Деплой

При деплое на сервер:

✅ **Папка `public/images/trainings/` НЕ загружается** - она исключена из rsync  
✅ **Скрипт проверяет**, что все изображения имеют данные в БД  
✅ **Предупреждение**, если найдены изображения без данных  

### Проверка перед деплоем

Скрипт деплоя автоматически проверяет:

```bash
SELECT COUNT(*) FROM news_images WHERE image_data IS NULL;
```

Если найдены изображения без данных, будет показано предупреждение.

## Устаревший код

Файл `src/lib/news-data.ts` содержит устаревший код:
- `trainingImagesMap` - маппинг путей к изображениям (не используется)
- `generateTrainingNews()` - генерация новостей из папок (не используется)

Этот код оставлен только как fallback для разработки, но **не используется в продакшене**.

## API Endpoints

### Получение изображения

```
GET /api/images/{id}
```

**Ответ:**
- Content-Type: `image/jpeg` (или другой MIME-тип)
- Body: бинарные данные изображения
- Cache-Control: `public, max-age=31536000, immutable`

### Использование в компонентах

```tsx
<Image
  src={`/api/images/${imageId}`}
  alt="Description"
  width={800}
  height={600}
/>
```

## Преимущества

1. **Нет зависимости от файловой системы** - все в БД
2. **Простой деплой** - не нужно загружать файлы отдельно
3. **Централизованное управление** - все через админ-панель
4. **Бэкапы** - изображения включены в бэкап БД
5. **Производительность** - кэширование через HTTP заголовки

## Миграция существующих данных

Если у вас уже есть изображения в файловой системе:

1. Убедитесь, что все пути сохранены в `news_images.image_url`
2. Запустите миграцию: `npm run migrate:db-images`
3. Проверьте, что все изображения импортированы:
   ```sql
   SELECT COUNT(*) FROM news_images WHERE image_data IS NULL;
   ```
4. После успешной миграции папку `public/images/trainings/` можно удалить (или оставить как архив)

## Troubleshooting

### Изображения не отображаются

1. Проверьте, что изображение имеет данные в БД:
   ```sql
   SELECT id, image_url, 
          CASE WHEN image_data IS NULL THEN 'NO DATA' ELSE 'HAS DATA' END as status
   FROM news_images 
   WHERE id = 'your-image-id';
   ```

2. Проверьте API endpoint:
   ```bash
   curl -I http://localhost:3000/api/images/{id}
   ```

3. Проверьте логи контейнера:
   ```bash
   docker logs fb-net-nextjs-prod
   ```

### Ошибка при миграции

Если файл не найден:
- Проверьте путь в `image_url`
- Убедитесь, что файл существует в `public/images/trainings/`
- Проверьте права доступа к файлам

Если файл слишком большой (>50MB):
- Скрипт пропустит его с предупреждением
- Рассмотрите оптимизацию изображения перед миграцией
