# Настройка шаблонов писем

## Описание

В админ панели добавлен раздел "Настройки" для управления шаблонами писем, которые отправляются при заполнении форм на сайте.

## Установка

### 1. Применить миграцию базы данных

Миграция будет применена автоматически при следующем деплое через скрипт `deploy-from-github.ps1`.

Если нужно применить вручную:

```bash
# Через docker exec (если используете Docker)
docker exec -i <container_name> psql -U postgres -d postgres -f /migrations/005_add_email_templates.sql

# Или локально
psql -U postgres -d postgres -f migrations/005_add_email_templates.sql
```

### 2. Проверка

После применения миграции:
1. Войдите в админ панель
2. Перейдите в раздел "Настройки"
3. Вы должны увидеть шаблоны для всех форм

## Использование

### Редактирование шаблонов

1. Откройте раздел **Настройки** в админ панели
2. Выберите форму (Контактная форма, Запрос КП, Заявка на обучение, Регистрация на конференцию)
3. Выберите тип письма (Администратору или Пользователю)
4. Отредактируйте тему и HTML содержимое
5. Нажмите "Сохранить шаблон"

### Переменные в шаблонах

Используйте переменные в формате `{{variable}}` для подстановки данных:

**Контактная форма:**
- `{{name}}` - имя отправителя
- `{{email}}` - email отправителя
- `{{phone}}` - телефон отправителя
- `{{message}}` - сообщение
- `{{date}}` - дата отправки

**Запрос КП / Заявка на обучение:**
- `{{name}}` - ФИО
- `{{phone}}` - телефон
- `{{email}}` - email
- `{{city}}` - город
- `{{institution}}` - медицинское учреждение
- `{{date}}` - дата

**Регистрация на конференцию:**
- `{{conference}}` - название конференции
- `{{name}}` - ФИО
- `{{email}}` - email
- `{{phone}}` - телефон
- `{{institution}}` - учреждение (опционально)
- `{{certificate}}` - нужен ли сертификат (Да/Нет)
- `{{date}}` - дата регистрации
- `{{siteUrl}}` - URL сайта (только для пользователя)
- `{{siteHostname}}` - домен сайта (только для пользователя)

### Условные блоки

Поддерживаются условные блоки для опциональных полей:

```html
{{#if institution}}
<p><strong>Учреждение:</strong> {{institution}}</p>
{{/if}}
```

## Структура

- `migrations/005_add_email_templates.sql` - SQL миграция для создания таблицы (применяется автоматически при деплое)
- `src/app/admin/settings/page.tsx` - страница настроек в админ панели
- `src/app/api/admin/email-templates/route.ts` - API для работы с шаблонами
- `src/lib/email-templates.ts` - утилиты для работы с шаблонами
- `src/app/api/contact/route.ts` - обновлен для использования шаблонов
- `src/app/api/request-cp/route.ts` - обновлен для использования шаблонов
- `src/app/api/conferences/register/route.ts` - обновлен для использования шаблонов

## Fallback

Если шаблон не найден в базе данных, используется встроенный шаблон по умолчанию (старое поведение).
