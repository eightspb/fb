# Миграции базы данных

## Текущий статус

**Папка пустая** - все миграции были перенесены в основной файл `database-schema.sql`.

## Почему?

Ранее миграции дублировали изменения, которые уже были в `database-schema.sql`:
- Добавление поля `slug` для конференций
- Добавление полей `date_end`, `cover_image`, `speakers` и др.
- Индексы для новостей
- Таблицы аналитики (`visitor_sessions`, `page_visits`, `ip_geolocation_cache`)

Это приводило к ошибкам при деплое, так как:
1. Таблица `schema_migrations` не создавалась автоматически
2. Миграции пытались применить изменения, которые уже существовали
3. Скрипт деплоя тратил время на проверку миграций

## Как работать с изменениями БД теперь?

### Для новых установок
База создается из `database-schema.sql` - в нем уже есть все необходимые таблицы и поля.

### Для существующих установок
Если нужно добавить новую функциональность, требующую изменения структуры БД:

**Вариант 1 (рекомендуется для новых таблиц):**
- Добавьте CREATE TABLE в `database-schema.sql` с `IF NOT EXISTS`
- Таблица создастся автоматически при следующем запуске

**Вариант 2 (для изменения существующих таблиц):**
1. Создайте файл миграции в этой папке (например, `2026-02-05-add-field.sql`)
2. Используйте безопасные команды:
   ```sql
   ALTER TABLE table_name ADD COLUMN IF NOT EXISTS field_name TYPE;
   CREATE INDEX IF NOT EXISTS index_name ON table_name(field);
   ```
3. Добавьте эти же изменения в `database-schema.sql`
4. Скрипт деплоя автоматически применит миграцию

**Вариант 3 (для срочных изменений):**
- Выполните SQL напрямую в БД через `docker exec`:
  ```bash
  docker exec -it fb-net-db psql -U postgres -d postgres
  ```

## Важно

- Всегда используйте `IF NOT EXISTS` / `IF EXISTS` для безопасности
- Обновляйте `database-schema.sql` вместе с миграциями
- Скрипт деплоя автоматически пропускает уже примененные миграции
- Для быстрого деплоя без миграций: `.\scripts\deploy-from-github.ps1 -AppOnly -SkipMigrations`
