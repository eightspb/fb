#!/bin/bash
# ะกะบัะธะฟั ะฟัะพะฒะตัะบะธ ะฑะตะทะพะฟะฐัะฝะพััะธ ัะตัะฒะตัะฐ ะธ ะบะพะฝัะตะนะฝะตัะพะฒ
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./scripts/security-check.sh

set -e

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "           ะะะะะะะะ ะะะะะะะกะะะกะขะ ะกะะะะะะ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ะคัะฝะบัะธะธ
check_suspicious_processes() {
    echo "๐ ะัะพะฒะตัะบะฐ ะฟะพะดะพะทัะธัะตะปัะฝัั ะฟัะพัะตััะพะฒ..."
    
    # ะัะพะฒะตัะบะฐ ะฟัะพัะตััะพะฒ ะฒ /tmp
    SUSPICIOUS=$(ps aux | grep -E '/tmp/[^/]+$' | grep -v grep || true)
    if [ -n "$SUSPICIOUS" ]; then
        echo -e "${RED}โ๏ธ  ะะะะะะะซ ะะะะะะะะขะะะฌะะซะ ะะะะฆะะกะกะซ ะ /tmp:${NC}"
        echo "$SUSPICIOUS"
        return 1
    else
        echo -e "${GREEN}โ ะะพะดะพะทัะธัะตะปัะฝัะต ะฟัะพัะตััั ะฝะต ะฝะฐะนะดะตะฝั${NC}"
    fi
}

check_cpu_usage() {
    echo ""
    echo "๐ป ะัะพะฒะตัะบะฐ ะทะฐะณััะทะบะธ CPU..."
    
    # ะัะพะฒะตัะบะฐ ะฟัะพัะตััะพะฒ ั ะฒััะพะบะพะน ะทะฐะณััะทะบะพะน
    HIGH_CPU=$(ps aux --sort=-%cpu | head -6)
    echo "$HIGH_CPU"
    
    # ะัะพะฒะตัะบะฐ ััะตะดะฝะตะน ะทะฐะณััะทะบะธ
    LOAD=$(uptime | awk -F'load average:' '{print $2}')
    echo "ะกัะตะดะฝัั ะทะฐะณััะทะบะฐ:$LOAD"
}

check_docker_containers() {
    echo ""
    echo "๐ณ ะัะพะฒะตัะบะฐ Docker ะบะพะฝัะตะนะฝะตัะพะฒ..."
    
    if ! command -v docker &> /dev/null; then
        echo -e "${YELLOW}โ๏ธ  Docker ะฝะต ัััะฐะฝะพะฒะปะตะฝ${NC}"
        return 0
    fi
    
    # ะกะฟะธัะพะบ ะทะฐะฟััะตะฝะฝัั ะบะพะฝัะตะนะฝะตัะพะฒ
    docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
    
    echo ""
    echo "ะัะพะฒะตัะบะฐ ะฟัะพัะตััะพะฒ ะฒะฝัััะธ fb-net-app..."
    if docker ps | grep -q fb-net-app; then
        CONTAINER_PROCS=$(docker exec fb-net-app ps aux 2>/dev/null || true)
        
        # ะัะพะฒะตัะบะฐ ะฝะฐ ะฟะพะดะพะทัะธัะตะปัะฝัะต ะฟัะพัะตััั
        if echo "$CONTAINER_PROCS" | grep -qE '/tmp/|/dev/shm/' | grep -v grep; then
            echo -e "${RED}โ๏ธ  ะะะะะะะซ ะะะะะะะะขะะะฌะะซะ ะะะะฆะะกะกะซ ะ ะะะะขะะะะะะ!${NC}"
            echo "$CONTAINER_PROCS" | grep -E '/tmp/|/dev/shm/'
            return 1
        else
            echo -e "${GREEN}โ ะะพะฝัะตะนะฝะตั ัะธัั${NC}"
        fi
        
        # ะะพะบะฐะทะฐัั ะฒัะต ะฟัะพัะตััั
        echo ""
        echo "ะัะต ะฟัะพัะตััั ะฒ ะบะพะฝัะตะนะฝะตัะต:"
        echo "$CONTAINER_PROCS"
    else
        echo -e "${YELLOW}โ๏ธ  ะะพะฝัะตะนะฝะตั fb-net-app ะฝะต ะทะฐะฟััะตะฝ${NC}"
    fi
}

check_tmp_files() {
    echo ""
    echo "๐ ะัะพะฒะตัะบะฐ ะฟะพะดะพะทัะธัะตะปัะฝัั ัะฐะนะปะพะฒ ะฒ /tmp..."
    
    # ะะพะธัะบ ะธัะฟะพะปะฝัะตะผัั ัะฐะนะปะพะฒ ะฒ /tmp
    SUSPICIOUS_FILES=$(find /tmp -type f -executable 2>/dev/null | head -20 || true)
    if [ -n "$SUSPICIOUS_FILES" ]; then
        echo -e "${YELLOW}โ๏ธ  ะะฐะนะดะตะฝั ะธัะฟะพะปะฝัะตะผัะต ัะฐะนะปั:${NC}"
        echo "$SUSPICIOUS_FILES"
    else
        echo -e "${GREEN}โ ะะพะดะพะทัะธัะตะปัะฝัะต ัะฐะนะปั ะฝะต ะฝะฐะนะดะตะฝั${NC}"
    fi
    
    # ะะพะธัะบ ัะบััััั ะฟะฐะฟะพะบ
    HIDDEN_DIRS=$(find /tmp -maxdepth 1 -type d -name '.*' 2>/dev/null | grep -v '^\.$' | grep -v '^\.\.$' || true)
    if [ -n "$HIDDEN_DIRS" ]; then
        echo -e "${YELLOW}โ๏ธ  ะะฐะนะดะตะฝั ัะบััััะต ะดะธัะตะบัะพัะธะธ:${NC}"
        echo "$HIDDEN_DIRS"
    fi
}

check_network_connections() {
    echo ""
    echo "๐ ะัะพะฒะตัะบะฐ ัะตัะตะฒัั ัะพะตะดะธะฝะตะฝะธะน..."
    
    # ะัะพะฒะตัะบะฐ ะฝะตะพะฑััะฝัั ะธััะพะดััะธั ัะพะตะดะธะฝะตะฝะธะน
    echo "ะะบัะธะฒะฝัะต ะธััะพะดััะธะต ัะพะตะดะธะฝะตะฝะธั (ะฝะต SSH/HTTP/HTTPS):"
    SUSPICIOUS_CONN=$(ss -tupn 2>/dev/null | grep -E 'ESTAB|SYN-SENT' | grep -vE '(:22|:80|:443|:3000|:5432)' || true)
    if [ -n "$SUSPICIOUS_CONN" ]; then
        echo -e "${YELLOW}โ๏ธ  ะะฐะนะดะตะฝั ะฝะตะพะฑััะฝัะต ัะพะตะดะธะฝะตะฝะธั:${NC}"
        echo "$SUSPICIOUS_CONN"
    else
        echo -e "${GREEN}โ ะขะพะปัะบะพ ััะฐะฝะดะฐััะฝัะต ัะพะตะดะธะฝะตะฝะธั${NC}"
    fi
}

check_npm_vulnerabilities() {
    echo ""
    echo "๐ฆ ะัะพะฒะตัะบะฐ npm ะทะฐะฒะธัะธะผะพััะตะน ะฝะฐ ััะทะฒะธะผะพััะธ..."
    
    if command -v bun &> /dev/null; then
        echo "ะัะฟะพะปัะทัะตะผ bun audit..."
        bun audit || echo -e "${YELLOW}โ๏ธ  ะะฐะนะดะตะฝั ััะทะฒะธะผะพััะธ ะฒ ะทะฐะฒะธัะธะผะพัััั${NC}"
    elif command -v npm &> /dev/null; then
        echo "ะัะฟะพะปัะทัะตะผ npm audit..."
        npm audit --production || echo -e "${YELLOW}โ๏ธ  ะะฐะนะดะตะฝั ััะทะฒะธะผะพััะธ ะฒ ะทะฐะฒะธัะธะผะพัััั${NC}"
    else
        echo -e "${YELLOW}โ๏ธ  npm/bun ะฝะต ัััะฐะฝะพะฒะปะตะฝ${NC}"
    fi
}

# ะัะฝะพะฒะฝะฐั ะฟัะพะฒะตัะบะฐ
main() {
    check_suspicious_processes
    check_cpu_usage
    check_docker_containers
    check_tmp_files
    check_network_connections
    
    if [ -f "package.json" ]; then
        check_npm_vulnerabilities
    fi
    
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo -e "${GREEN}           ะะะะะะะะ ะะะะะะจะะะ${NC}"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    echo "ะะตะบะพะผะตะฝะดะฐัะธะธ:"
    echo "1. ะะตะณัะปััะฝะพ ะทะฐะฟััะบะฐะนัะต ััะพั ัะบัะธะฟั (ะดะพะฑะฐะฒััะต ะฒ cron)"
    echo "2. ะะพะฝะธัะพัััะต ะทะฐะณััะทะบั CPU/ะฟะฐะผััะธ"
    echo "3. ะะฑะฝะพะฒะปัะนัะต ะทะฐะฒะธัะธะผะพััะธ: bun update"
    echo "4. ะัะพะฒะตััะนัะต ะปะพะณะธ: docker compose logs -f"
}

# ะะฐะฟััะบ
main
