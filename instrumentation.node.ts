/**
 * Node.js-specific error handlers
 * Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Node.js runtime
 */

import type { notifyAdminAboutError as NotifyFn } from './src/lib/telegram-notifications';

/**
 * Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Node.js ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
 */
export async function initializeNodeErrorHandlers() {
  const { notifyAdminAboutError } = await import('./src/lib/telegram-notifications');

  console.log('[INSTRUMENTATION] ðŸ”§ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Node.js Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¾Ð² Ð¾ÑˆÐ¸Ð±Ð¾Ðº...');

  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚, ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð½ÐµÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾Ð¹ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Server Action Ð¾ÑˆÐ¸Ð±ÐºÐ¸)
  const isNonCriticalError = (error: Error | string): boolean => {
    const errorMessage = typeof error === 'string' ? error : error.message;
    const errorStack = typeof error === 'string' ? '' : error.stack || '';
    
    // Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Server Actions - Ð¾Ð½Ð¸ Ð½Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹
    if (errorMessage.includes('Failed to find Server Action') ||
        errorMessage.includes('Server Action') && errorMessage.includes('not found')) {
      return true;
    }
    
    // Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ñ ÐºÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Next.js
    if (errorMessage.includes('This request might be from an older or newer dep')) {
      return true;
    }
    
    return false;
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð½ÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ñ… Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹
  process.on('uncaughtException', (error: Error) => {
    // ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½ÐµÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Server Actions)
    if (isNonCriticalError(error)) {
      console.warn('[INSTRUMENTATION] âš ï¸  ÐÐµÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° (Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ):', error.message);
      return;
    }
    
    console.error('[INSTRUMENTATION] âŒ ÐÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ð¾Ðµ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ:', error);
    
    notifyAdminAboutError(error, {
      location: 'uncaughtException',
      additionalInfo: {
        type: 'uncaught_exception',
      },
    }).catch(() => {
      // Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
    });

    // Ð”Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
    setTimeout(() => {
      process.exit(1);
    }, 1000);
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð½ÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð¼Ð¸ÑÐ¾Ð²
  process.on('unhandledRejection', (reason: any) => {
    const error = reason instanceof Error 
      ? reason 
      : new Error(`Unhandled Rejection: ${String(reason)}`);
    
    // ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½ÐµÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Server Actions)
    if (isNonCriticalError(error)) {
      console.warn('[INSTRUMENTATION] âš ï¸  ÐÐµÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ð¹ rejection (Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ):', error.message);
      return;
    }
    
    console.error('[INSTRUMENTATION] âŒ ÐÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ rejection:', reason);

    notifyAdminAboutError(error, {
      location: 'unhandledRejection',
      additionalInfo: {
        type: 'unhandled_rejection',
        reason: String(reason),
      },
    }).catch(() => {
      // Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
    });
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
  const shutdownHandler = (signal: string) => {
    console.log(`[INSTRUMENTATION] ðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ ÑÐ¸Ð³Ð½Ð°Ð» ${signal}, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹...`);
  };
  
  process.on('SIGTERM', () => shutdownHandler('SIGTERM'));
  process.on('SIGINT', () => shutdownHandler('SIGINT'));

  console.log('[INSTRUMENTATION] âœ… Node.js Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹');
}
