# Инструкция по использованию скрипта деплоя

## Обзор

Скрипт `deploy-to-server.sh` (или `deploy-to-server.ps1` для Windows) автоматизирует процесс обновления сервера с защитой от потери данных.

## Возможности

✅ **Автоматический бэкап базы данных** - создается перед каждым обновлением  
✅ **Безопасное применение миграций** - миграции применяются только один раз  
✅ **Загрузка файлов** - синхронизация только необходимых файлов  
✅ **Перезапуск контейнеров** - автоматический перезапуск с пересборкой  
✅ **Защита от ошибок** - остановка при любой ошибке с сохранением бэкапа  

## Требования

1. **SSH доступ** к серверу с настроенным ключом (или паролем)
2. **rsync** установлен на локальной машине (для Linux/Mac) или WSL (для Windows)
3. **Docker и Docker Compose** установлены на сервере
4. Проект уже развернут на сервере (первый деплой делается вручную)

## Использование

### Linux/Mac или WSL/Git Bash

```bash
# Первый раз: сделайте скрипт исполняемым
chmod +x scripts/deploy-to-server.sh

# Запуск деплоя
./scripts/deploy-to-server.sh user@your-server /opt/fb-net
```

### Windows PowerShell

```powershell
.\scripts\deploy-to-server.ps1 -Server user@your-server -RemotePath /opt/fb-net
```

**Параметры:**
- `user@your-server` - обязательный параметр, пользователь и адрес сервера
- `/opt/fb-net` - опциональный параметр, путь к проекту на сервере (по умолчанию `/opt/fb-net`)

## Что исключается при загрузке

Скрипт автоматически исключает следующие файлы и папки:
- `node_modules/` - зависимости устанавливаются в контейнере
- `.next/` - сборка происходит в Docker
- `.git/` - репозиторий не нужен на сервере
- `backups/` - локальные бэкапы
- `*.log` - логи
- `.env*` - файлы окружения (кроме `.env.example`)
- `public/images/trainings/` - **ВАЖНО: изображения хранятся только в БД, не загружаются на сервер**
- `.DS_Store`, `*.tsbuildinfo` - служебные файлы

## Хранение изображений

**Все изображения хранятся только в базе данных**, а не в файловой системе. Это означает:

✅ **Изображения читаются только из БД** через API endpoint `/api/images/{id}`  
✅ **Нет зависимости от файловой системы** - изображения не нужно загружать отдельно  
✅ **Нет хардкодинга путей** - все пути генерируются динамически из БД  
✅ **Папка `public/images/trainings/` не загружается** на сервер при деплое  

Перед деплоем скрипт проверяет, что все изображения имеют данные в БД (`image_data IS NOT NULL`). Если найдены изображения без данных, будет показано предупреждение.

## Процесс деплоя

1. **Проверка подключения** - проверяется доступность сервера
2. **Создание бэкапа** - создается SQL дамп базы данных
3. **Загрузка файлов** - синхронизация файлов через rsync
4. **Применение миграций** - безопасное применение миграций из `migrations/`
5. **Перезапуск контейнеров** - остановка, пересборка и запуск

## Безопасность миграций

Скрипт использует таблицу `schema_migrations` для отслеживания примененных миграций:

```sql
CREATE TABLE IF NOT EXISTS schema_migrations (
    name VARCHAR(255) PRIMARY KEY,
    applied_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

Каждая миграция проверяется перед применением. Если миграция уже применена, она пропускается.

**Важно:** Миграции должны быть идемпотентными (использовать `IF NOT EXISTS`, `IF EXISTS` и т.д.)

## Бэкапы

Бэкапы сохраняются локально в папке `backups/` с именем:
```
db_backup_YYYYMMDD_HHMMSS.sql
```

Рекомендуется:
- Периодически архивировать старые бэкапы
- Хранить бэкапы в отдельном месте (не в репозитории)
- Настроить автоматическую очистку старых бэкапов

## Восстановление из бэкапа

Если что-то пошло не так, можно восстановить базу данных:

```bash
# Linux/Mac
./scripts/restore-database.sh backups/db_backup_20240130_120000.sql user@your-server /opt/fb-net
```

**ВНИМАНИЕ:** Восстановление полностью перезапишет текущую базу данных!

## Устранение проблем

### Ошибка подключения к серверу

```bash
# Проверьте SSH подключение
ssh user@your-server "echo 'OK'"

# Проверьте настройки SSH ключей
ssh-add -l
```

### Ошибка при создании бэкапа

- Убедитесь, что контейнер БД запущен
- Проверьте имя контейнера в `docker-compose.production.yml`
- Проверьте права доступа к базе данных

### Ошибка при применении миграций

- Проверьте синтаксис SQL в файлах миграций
- Убедитесь, что миграции идемпотентны
- Проверьте логи контейнера БД: `docker logs fb-net-supabase-db-prod`

### rsync не найден (Windows)

Установите один из вариантов:
1. **WSL** (Windows Subsystem for Linux) - рекомендуется
2. **Git Bash** - входит в Git for Windows
3. **Cygwin** - альтернативный вариант

Или используйте PowerShell скрипт, который попытается использовать WSL автоматически.

## Примеры использования

### Базовый деплой

```bash
./scripts/deploy-to-server.sh deploy@192.168.1.100
```

### Деплой с указанием пути

```bash
./scripts/deploy-to-server.sh deploy@myserver.com /var/www/fb-net
```

### Проверка перед деплоем

```bash
# Сначала проверьте подключение
ssh deploy@myserver.com "cd /opt/fb-net && docker compose -f docker-compose.production.yml ps"

# Затем запустите деплой
./scripts/deploy-to-server.sh deploy@myserver.com
```

## Рекомендации

1. **Тестируйте миграции локально** перед деплоем на продакшн
2. **Делайте ручные бэкапы** перед важными обновлениями
3. **Проверяйте логи** после деплоя: `docker compose -f docker-compose.production.yml logs -f`
4. **Используйте CI/CD** для автоматизации (GitHub Actions, GitLab CI и т.д.)
5. **Мониторьте сервер** после деплоя на наличие ошибок

## Интеграция с CI/CD

Пример для GitHub Actions:

```yaml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to server
        run: |
          chmod +x scripts/deploy-to-server.sh
          ./scripts/deploy-to-server.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} ${{ secrets.SERVER_PATH }}
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
```
