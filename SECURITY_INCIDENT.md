# Отчёт об инциденте безопасности

**Дата:** 04.02.2026
**Статус:** КРИТИЧЕСКИЙ - УСТРАНЁН

## Обнаруженные проблемы

### 1. Криптомайнер в Docker контейнере
- **Процессы:** `hskrxvrl3zG8`, `/tmp/nextjs`, `/tmp/sheovuceplca`
- **CPU:** 93-123% загрузка
- **Память:** 2.4GB использования
- **Пользователь:** nextjs (uid 1001) внутри Docker контейнера

### 2. Вредоносные файлы
Обнаружены поддельные системные файлы в `/tmp/`:
- `/tmp/.agetty/`, `/tmp/.irqbalance/`, `/tmp/.mysqld/`
- `/tmp/.systemd-*`, `/tmp/.postgres/`, `/tmp/.node_exporter/`

### 3. Ошибки подключения
Повторяющиеся попытки подключения к `193.142.147.209:12323` (майнинг пул)

## Предпринятые действия

1. ✅ Убиты все вредоносные процессы
2. ✅ Удалены контейнеры и образы
3. ✅ Очищена Docker система (8.7GB)
4. ✅ Проверены SSH логи - входы легитимные
5. ✅ Проверена конфигурация безопасности

## Возможные точки входа

### ⚠️ НАЙДЕНА КРИТИЧЕСКАЯ УЯЗВИМОСТЬ (наиболее вероятная причина)

**Next.js 15.5.6 - CVE: Remote Code Execution (RCE)**
- **Уязвимость:** `GHSA-9qr9-h5gf-34mp` - RCE в React flight protocol
- **Версия:** 15.5.0-canary.0 до 15.5.7
- **Критичность:** CRITICAL
- **Исправление:** Обновление до Next.js 15.5.7+ или 16.1.6+

Эта RCE уязвимость позволяла злоумышленнику выполнять произвольный код на сервере,
что объясняет появление майнера в контейнере.

**Дополнительные уязвимости:**
1. ~~nodemailer <7.0.7 - moderate~~ ✅ Исправлено (обновлено до 8.0.0)
2. ~~fast-xml-parser DoS~~ ✅ Исправлено
3. ~~js-yaml prototype pollution~~ ✅ Исправлено
4. node-telegram-bot-api (транзитивные зависимости qs, lodash) - moderate/high

### Другие возможные векторы (менее вероятные):
1. Загрузка файлов без проверки
2. SQL injection с выполнением команд

## Рекомендации по безопасности

### Немедленно (КРИТИЧНО)
- [x] Пересканировать все npm зависимости ✅
- [x] Обновить Next.js до безопасной версии (16.1.6) ✅
- [x] Обновить nodemailer до безопасной версии (8.0.0) ✅
- [x] Ограничить права пользователя в контейнере ✅
- [x] Добавить read-only файловую систему где возможно ✅
- [x] Отключить /tmp в контейнере или сделать noexec ✅

### Краткосрочно
- [ ] Настроить мониторинг CPU/памяти с алертами
- [ ] Добавить Web Application Firewall (WAF)
- [ ] Регулярные сканирования на вредоносное ПО
- [ ] Логирование всех системных вызовов в контейнере

### Долгосрочно
- [ ] Переход на rootless Docker
- [ ] Использование AppArmor/SELinux профилей
- [ ] Регулярные аудиты безопасности
- [ ] Автоматические обновления зависимостей

## Проверка зависимостей

```bash
# Сканирование уязвимостей
bun audit

# Обновление зависимостей
bun update

# Проверка устаревших пакетов
bun outdated
```

### Результаты после обновления (04.02.2026)

**До обновления:** 10 уязвимостей (1 critical, 3 high, 5 moderate, 1 low)
- ❌ Next.js 15.5.6 - RCE (CRITICAL)
- ❌ nodemailer <7.0.7 (moderate)
- ❌ fast-xml-parser DoS (high)
- ❌ js-yaml prototype pollution (moderate)
- ❌ qs DoS (high)
- ❌ lodash prototype pollution (moderate)

**После обновления:** 2 уязвимости (1 high, 1 moderate)
- ✅ Next.js 16.1.6 - Все критические уязвимости исправлены
- ✅ nodemailer 8.0.0 - Все уязвимости исправлены
- ⚠️ qs <6.14.1 (high) - в node-telegram-bot-api (транзитивная)
- ⚠️ lodash 4.17.22 (moderate) - в node-telegram-bot-api (транзитивная)

**Обновлённые пакеты:**
- next: 15.5.6 → 16.1.6
- nodemailer: 6.9.16 → 8.0.0
- react: 19.1.0 → 19.2.4
- react-dom: 19.1.0 → 19.2.4
- node-telegram-bot-api: 0.66.0 → 0.67.0

## Мониторинг

Добавить алерты на:
- CPU > 80% более 5 минут
- Процессы в /tmp/
- Исходящие соединения на нестандартные порты
- Изменения в контейнере после запуска
