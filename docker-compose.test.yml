# Docker Compose –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏

services:
  # PostgreSQL –¥–ª—è —Ç–µ—Å—Ç–æ–≤
  postgres:
    image: postgres:15
    container_name: fb-net-test-postgres
    environment:
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: test_db
    ports:
      - "54323:5432"
    volumes:
      - test-postgres-data:/var/lib/postgresql/data
      # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ö–µ–º—É –ë–î –¥–ª—è —Ç–µ—Å—Ç–æ–≤
      - ./database-schema.sql:/docker-entrypoint-initdb.d/00-init-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d test_db"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - test-network

  # Redis –¥–ª—è rate limiting (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
  redis:
    image: redis:7-alpine
    container_name: fb-net-test-redis
    ports:
      - "63790:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - test-network

  # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
  app:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: fb-net-test-app
    environment:
      NODE_ENV: test
      DATABASE_URL: postgresql://test_user:test_password@postgres:5432/test_db
      JWT_SECRET: test-jwt-secret-key-for-testing-only
      ADMIN_PASSWORD: test-admin-password
      TELEGRAM_BOT_TOKEN: mock-telegram-token
      OPENROUTER_API_KEY: mock-openrouter-key
      NEXT_PUBLIC_SITE_URL: http://localhost:3000
      # Redis –¥–ª—è rate limiting
      UPSTASH_REDIS_REST_URL: http://redis:6379
      UPSTASH_REDIS_REST_TOKEN: mock-token
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - test-network
    # –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
    command: >
      sh -c "
        echo 'üß™ –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤...' &&
        bun run test:unit &&
        echo '‚úÖ Unit —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã' &&
        echo 'üß™ –ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç–æ–≤...' &&
        bun run test:e2e &&
        echo '‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã'
      "
    volumes:
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –∫–æ–¥ –¥–ª—è hot reload –≤ —Ç–µ—Å—Ç–∞—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - .:/app
      - /app/node_modules
      - /app/.next

volumes:
  test-postgres-data:

networks:
  test-network:
    driver: bridge
